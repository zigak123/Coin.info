app.component("coinDetails",{templateUrl:"/public/dist/templates/coinDetails.html",controller:["$scope","$state","$stateParams","$http","tickerSrv","$transitions","$rootScope","$interval","$mdMedia","$timeout","dataSrv",function(r,e,o,t,l,i,d,s,c,m,h){null==o.coin_data&&e.go("coinlist"),r.isLoading=!0,r.candleSizes=[{label:"15min",timeUnit:"minute",timeSize:15,periods:["15mm"]},{label:"1h",timeUnit:"hour",timeSize:1,periods:["hh","DD"]},{label:"2h",timeUnit:"hour",timeSize:2,periods:["2hh","DD"]},{label:"6h",timeUnit:"hour",timeSize:6,periods:["6hh","DD"]},{label:"1d",timeUnit:"day",timeSize:1,periods:["DD","WW"]}],r.zoomSizes=[{label:"1d",timeUnit:"day",timeSize:1},{label:"2d",timeUnit:"day",timeSize:2},{label:"1w",timeUnit:"day",timeSize:7},{label:"1M",timeUnit:"day",timeSize:30},{label:"1Y",timeUnit:"day",timeSize:365}],conversions={minute:1,hour:60,day:1440},r.selectedZ=r.zoomSizes[4],r.selectedC=r.candleSizes[4],r.coin_data=o.coin_data,r.coin_data.TotalCoinSupply=numeral(r.coin_data.TotalCoinSupply).format("0,0"),r.selectedChart="line",r.movingAverage=!1,r.movingAverage200=!1;var g="default"===d.currentTheme?"default":"dark",p=void 0,u=!1,v={BTC:8,EUR:2,USD:2},y=v[h.getCurrency()],b=function(e){r.volume=numeral(e.VOLUME24HOUR).format("0,0.00"),r.price=Number(e.PRICE.toString()),r.data=e,r.high24hour=e.HIGH24HOUR?e.HIGH24HOUR:r.high24hour,r.low24hour=e.LOW24HOUR?e.LOW24HOUR:r.low24hour,temp=1<r.price/oldprice?r.price/oldprice-1:-1*(1-r.price/oldprice),r.change=numeral(100*temp).format("0,0.00"),r.price_color=0<=r.change?{color:"limegreen"}:{color:"red"},r.priceArrow=0<=r.change?"public/dist/images/arrow_up.svg":"public/dist/images/arrow_drop.svg";var t=.5<=r.price?"0,0.00":"0,0.0000";if(t="BTC"==h.getCurrency()?"0,0.00000000":t,r.coin_market_cap=numeral(r.coin_supply_int*r.price).format("0,0"),null!=p){var a=p.dataSets[0].dataProvider.length,i=new Date(p.dataSets[0].dataProvider[a-1].time),o=new Date;"15min"===r.selectedC.label&&9e5<o-i&&!u?(u=!0,C().then(function(e){9e5<=new Date(1e3*e.Data[2].time)-new Date(p.dataSets[0].dataProvider[a-1].time)&&(p.dataSets[0].dataProvider[a-1].volumefrom=e.Data[1].volumefrom,p.dataSets[0].dataProvider[a-1].high=e.Data[1].high,p.dataSets[0].dataProvider[a-1].low=e.Data[1].low,p.dataSets[0].dataProvider[a-1].close=e.Data[1].close,p.dataSets[0].dataProvider[a-1].open=e.Data[1].open,p.dataSets[0].dataProvider[a-1].time=timeConverter(e.Data[1].time),p.dataSets[0].dataProvider.shift(),p.dataSets[0].dataProvider.push({time:timeConverter(e.Data[2].time),close:e.Data[2].close,open:e.Data[2].open,high:e.Data[2].high,low:e.Data[2].low,volumefrom:e.Data[2].volumefrom}),p.validateData()),u=!1})):"15min"===r.selectedC.label&&(p.dataSets[0].dataProvider[a-1].close=r.price,p.dataSets[0].dataProvider[a-1].high=p.dataSets[0].dataProvider[a-1].close>p.dataSets[0].dataProvider[a-1].high?r.price:p.dataSets[0].dataProvider[a-1].high,p.dataSets[0].dataProvider[a-1].low=p.dataSets[0].dataProvider[a-1].close<p.dataSets[0].dataProvider[a-1].low?r.price:p.dataSets[0].dataProvider[a-1].low,p.validateData())}r.price=numeral(r.price).format(t)},C=function(){return t({method:"GET",url:"https://min-api.cryptocompare.com/data/histominute?fsym="+r.coin_data.Symbol+"&tsym="+h.getCurrency()+"&limit=2&aggregate=15"}).then(function(e){return e.data})},S=function(){cc=r.selectedC.timeSize*conversions[r.selectedC.timeUnit],dd=r.selectedZ.timeSize*conversions[r.selectedZ.timeUnit],t({method:"GET",url:"https://min-api.cryptocompare.com/data/histo"+r.selectedC.timeUnit+"?fsym="+r.coin_data.Symbol+"&tsym="+h.getCurrency()+"&limit="+dd/cc+"&aggregate="+r.selectedC.timeSize}).then(function(e){chartData=e.data.Data;for(var t=0;t<chartData.length;t++)chartData[t].time=1e3*chartData[t].time;p.dataSets[0].dataProvider=chartData,p.categoryAxesSettings.minPeriod=r.selectedC.periods[0],p.categoryAxesSettings.groupToPeriods="line"==r.selectedChart?[r.selectedC.periods[0]]:r.selectedC.periods,p.dataSets[0].dataProvider.length<365==0&&(p.panels[0].hideGraph(p.panels[0].stockGraphs[2]),p.panels[0].hideGraph(p.panels[0].stockGraphs[3]),AmCharts.addMovingAverage(p.dataSets[0],p.panels[0],"close")),p.validateData(),p.zoom(new Date(p.dataSets[0].dataProvider[Math.ceil(p.dataSets[0].dataProvider.length/2)-1].time),new Date)},function(e){console.log(e)})};r.changeZoom=function(e){r.selectedZ!=e&&(document.getElementById("curtain").style.visibility="visible",document.getElementById("backgroundcurtain").style.visibility="visible",r.selectedZ=e,S())},r.changeCandle=function(e){r.selectedC!=e&&(p.panels[0].stockGraphs[0].type=r.selectedChart,document.getElementById("curtain").style.visibility="visible",document.getElementById("backgroundcurtain").style.visibility="visible",r.selectedC=e,S())},r.changeChartType=function(e){document.getElementById("curtain").style.visibility="visible",document.getElementById("backgroundcurtain").style.visibility="visible",r.selectedChart=e,"line"==r.selectedChart?(p.categoryAxesSettings.minPeriod=r.selectedC.periods[0],p.categoryAxesSettings.groupToPeriods=[r.selectedC.periods[0]],p.panels[0].showGraph(p.panels[0].stockGraphs[0]),p.panels[0].hideGraph(p.panels[0].stockGraphs[1])):(p.categoryAxesSettings.minPeriod=r.selectedC.periods[0],p.categoryAxesSettings.groupToPeriods=r.selectedC.periods,p.panels[0].showGraph(p.panels[0].stockGraphs[1]),p.panels[0].hideGraph(p.panels[0].stockGraphs[0])),p.validateData()},r.addMovingAverage=function(e){p.dataSets[0].dataProvider.length<365||(r.movingAverage="50"==e?!r.movingAverage:r.movingAverage,r.movingAverage200="200"==e?!r.movingAverage200:r.movingAverage200,r.movingAverage&&"50"==e?p.panels[0].showGraph(p.panels[0].stockGraphs[2]):"50"==e&&p.panels[0].hideGraph(p.panels[0].stockGraphs[2]),r.movingAverage200&&"200"==e?p.panels[0].showGraph(p.panels[0].stockGraphs[3]):"200"==e&&p.panels[0].hideGraph(p.panels[0].stockGraphs[3]))},r.$on("$destroy",function(){l.unsub(r.coin_data.Symbol,b,h.getCurrency())}),m(function(){t({method:"GET",url:"https://min-api.cryptocompare.com/data/histoday?fsym="+r.coin_data.Symbol+"&tsym="+h.getCurrency()+"&limit=365"}).then(function(e){chartData=e.data.Data;for(var t=0;t<chartData.length;t++)chartData[t].time=1e3*chartData[t].time;var i={type:"stock",theme:g,balloon:{cornerRadius:6},processTimeout:"250",zoomEnabled:!0,dataSets:[{fieldMappings:[{fromField:"open",toField:"open"},{fromField:"close",toField:"close"},{fromField:"high",toField:"high"},{fromField:"low",toField:"low"},{fromField:"volumefrom",toField:"volumefrom"}],color:"#7f8da9",dataProvider:chartData,categoryField:"time"}],glueToTheEnd:!0,panels:[{title:"Price",showCategoryAxis:!1,fontFamily:"Roboto",percentHeight:70,hideCredits:!0,valueAxes:[{id:"v1",dashLength:5}],startDuration:0,categoryAxis:{dashLength:5},stockGraphs:[{type:"line",id:"g1",valueField:"close",lineColor:"#7f8da9",fillColors:"#7f8da9",fillAlphas:.1,useDataSetColors:!1,comparable:!0,compareField:"close",showBalloon:!0,balloonText:"Close:<b>[[close]]</b><br>",hidden:!1,balloonFunction:function(e,t){var a=t.balloonText;for(var i in e.dataContext)if(e.dataContext.hasOwnProperty(i)&&!isNaN(e.dataContext[i])){var o=AmCharts.formatNumber(e.dataContext[i],{precision:8,decimalSeparator:".",thousandsSeparator:","},y);a=a.replace("[["+i+"]]",o)}return a}},{type:"candlestick",id:"g2",openField:"open",closeField:"close",highField:"high",lowField:"low",valueField:"close",lineColor:"#7f8da9",fillColors:"#7f8da9",negativeLineColor:"#db4c3c",negativeFillColors:"#db4c3c",fillAlphas:.8,useDataSetColors:!1,comparable:!0,compareField:"value",showBalloon:!0,proCandlesticks:!0,hidden:!0,balloonFunction:function(e,t){return"Open:<b>"+e.dataContext.openOpen+"</b><br>Low:<b>"+e.dataContext.lowLow+"</b><br>High:<b>"+e.dataContext.highHigh+"</b><br>Close:<b>"+e.dataContext.closeClose+"</b><br>"}},{type:"line",id:"g3",valueField:"avg1",lineColor:"#7f8da9",fillAlphas:0,useDataSetColors:!1,comparable:!0,compareField:"avg1",showBalloon:!0,balloonText:"",hidden:!r.movingAverage,periodValue:"Average",balloonFunction:function(e,t){return r.movingAverage?"MA70: <b>"+e.dataContext["candlestick"==r.selectedChart?"avg1Average":"avg1"].toFixed(v[h.getCurrency()])+"<b>":" "}},{type:"line",id:"g4",valueField:"avg2",lineColor:"#ff9100",fillAlphas:0,useDataSetColors:!1,comparable:!0,compareField:"avg2",showBalloon:!0,balloonText:"",hidden:!r.movingAverage200,periodValue:"Average",balloonFunction:function(e,t){return r.movingAverage200?"MA200: <b>"+e.dataContext["candlestick"==r.selectedChart?"avg2Average":"avg2"].toFixed(v[h.getCurrency()])+"<b>":" "}}],stockLegend:{markerType:"none",markerSize:0,labelText:"",valueText:""}},{title:"Volume",percentHeight:30,showCategoryAxis:!0,hideCredits:!0,fontFamily:"Roboto",valueAxes:[{dashLength:5,usePrefixes:!0}],categoryAxis:{dashLength:5},stockGraphs:[{valueField:"volumefrom",type:"column",showBalloon:!1,fillAlphas:.8}],stockLegend:{markerType:"none",markerSize:0,labelText:"",periodValueTextComparing:"[[value.close]]"}}],chartScrollbarSettings:{graph:"g1",graphType:"line",position:"top",height:34,enabled:!1},valueAxesSettings:{inside:!0,showFirstLabel:!1},chartCursorSettings:{valueLineEnabled:!1,fullWidth:!0,cursorAlpha:.1,valueBalloonsEnabled:!0},export:{enabled:!1},panelsSettings:{marginLeft:0,marginRight:0},listeners:[{event:"rendered",method:function(e){document.getElementById("curtain").style.visibility="hidden",document.getElementById("backgroundcurtain").style.visibility="hidden"}},{event:"dataUpdated",method:function(e){document.getElementById("curtain").style.visibility="hidden",document.getElementById("backgroundcurtain").style.visibility="hidden",r.movingAverage=!(p.dataSets[0].dataProvider.length<365)&&r.movingAverage,r.movingAverage200=!(p.dataSets[0].dataProvider.length<365)&&r.movingAverage200}}]};AmCharts.addMovingAverage(i.dataSets[0],i.panels[0],"close"),(p=AmCharts.makeChart("chartdiv",i)).categoryAxesSettings.minPeriod=r.selectedC.periods[0],p.categoryAxesSettings.groupToPeriods=[r.selectedC.periods[0]],n=e.data.Data.length,oldprice=e.data.Data[n-1].open,l.subscribe(o.coin_data.Symbol,b,h.getCurrency()),p.addListener("zoomed",function(e){p.dataSets[0].dataProvider;e.startDate.getTime()>new Date(chartData[0].time).getTime()||e.endDate.getTime()<new Date(chartData[chartData.length-1].time)?document.getElementById("zoomout").style.visibility="visible":document.getElementById("zoomout").style.visibility="hidden",a=2}),r.isLoading=!1},function(e){console.log(e)})},200),r.zoomOut=function(){document.getElementById("zoomout");zoomout.style.visibility="hidden",p.zoomOut()},r.currency=h.getCurrency(),t({method:"GET",url:"https://min-api.cryptocompare.com/data/top/exchanges/full?fsym="+r.coin_data.Symbol+"&tsym="+h.getCurrency()}).then(function(e){r.coin_supply_int=e.data.Data.CoinInfo.TotalCoinsMined,r.coin_supply=numeral(r.coin_supply_int).format("0,0")})}]});